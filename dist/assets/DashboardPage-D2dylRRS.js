import{j as e,u as A,c as P,b as w}from"./query-BkJnI4n_.js";import{a as i}from"./router-Bpws6W79.js";import{c as p,d as z,a as L,n as y}from"./index-Dbt0Mu8K.js";import{t as k,f as S,a as q,T as K,Q as I,E as G,C as R}from"./format-BAxQCyRA.js";import"./redux-LWk2volp.js";const $=(t,s=250)=>{const[r,n]=i.useState(t);return i.useEffect(()=>{const a=setTimeout(()=>n(t),s);return()=>clearTimeout(a)},[t,s]),r},B=({documents:t,onDownload:s,onDelete:r,pendingDeleteId:n})=>e.jsx("div",{className:"overflow-hidden rounded-xl border border-slate-200 bg-white shadow-soft",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-200",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase text-slate-500",children:"File"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase text-slate-500",children:"Size"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase text-slate-500",children:"Uploaded"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold uppercase text-slate-500",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:t.map(a=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-slate-700",title:a.file_name,children:k(a.file_name,65)}),e.jsx("td",{className:"px-4 py-3 text-sm text-slate-600",children:S(a.file_size)}),e.jsx("td",{className:"px-4 py-3 text-sm text-slate-600",children:q(a.created_at)}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("div",{className:"inline-flex gap-2",children:[e.jsx("button",{className:"rounded-md border border-slate-300 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-100",onClick:()=>s(a.id),children:"Download"}),e.jsx("button",{className:"rounded-md border border-rose-300 px-3 py-1.5 text-xs font-medium text-rose-600 hover:bg-rose-50",onClick:()=>r(a.id),disabled:n===a.id,children:n===a.id?"Deleting...":"Delete"})]})})]},a.id))})]})})}),J=i.memo(B),C=10*1024*1024,T=["application/pdf","image/jpeg","image/png"],O=({isUploading:t,progress:s,onFileSelected:r})=>{const n=i.useRef(null);return e.jsxs("section",{className:"rounded-xl border border-slate-200 bg-white p-4 shadow-soft",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base font-semibold text-slate-900",children:"Upload document"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Allowed: PDF, JPG, PNG. Max size: ",S(C),"."]})]}),e.jsx("button",{className:"rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-700 disabled:opacity-70",disabled:t,onClick:()=>{var a;return(a=n.current)==null?void 0:a.click()},children:t?"Uploading...":"Choose File"})]}),e.jsx("input",{ref:n,"aria-label":"Upload legal document",type:"file",className:"hidden",accept:T.join(","),onChange:a=>{var h;const l=(h=a.target.files)==null?void 0:h[0];l&&(r(l),a.target.value="")}}),t?e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"h-2 rounded-full bg-slate-200",children:e.jsx("div",{className:"h-2 rounded-full bg-brand-500 transition-all",style:{width:`${s}%`}})}),e.jsxs("p",{className:"mt-1 text-xs text-slate-600",children:[s,"% uploaded"]})]}):null]})},W=t=>T.includes(t.type)?t.size>C?"File exceeds 10MB limit.":"":"File type not allowed. Use PDF, JPG, or PNG.",x={list:async(t,s)=>{const{data:r}=await p.get("/documents",{params:{page:t,limit:s}});return r},generateUploadUrl:async t=>{const{data:s}=await p.post("/documents/upload-url",t);return s},uploadToSignedUrl:async(t,s,r)=>{await z.put(t,s,{headers:{"Content-Type":s.type},onUploadProgress:n=>{!n.total||!r||r(Math.round(n.loaded*100/n.total))}})},confirmUpload:async t=>{const{data:s}=await p.post("/documents/confirm",t);return s},getDownloadUrl:async t=>{const{data:s}=await p.get(`/documents/${t}/download`);return s},delete:async t=>{const{data:s}=await p.delete(`/documents/${t}`);return s}},X=10,Y=t=>A({queryKey:["documents",t],queryFn:()=>x.list(t,X),placeholderData:s=>s,staleTime:3e4}),Z=()=>{const t=P();return w({mutationFn:async({file:s,onProgress:r})=>{const n=await x.generateUploadUrl({file_name:s.name,file_size:s.size,mime_type:s.type});return await x.uploadToSignedUrl(n.uploadUrl,s,r),x.confirmUpload({storageKey:n.storageKey,file_name:s.name,file_size:s.size,mime_type:s.type})},onSuccess:()=>{t.invalidateQueries({queryKey:["documents"]})}})},H=()=>{const t=P();return w({mutationFn:s=>x.delete(s),onMutate:async s=>{await t.cancelQueries({queryKey:["documents"]});const r=t.getQueriesData({queryKey:["documents"]});return r.forEach(([n,a])=>{a&&t.setQueryData(n,{...a,documents:a.documents.filter(l=>l.id!==s),total:Math.max(0,a.total-1)})}),{previous:r}},onError:(s,r,n)=>{n==null||n.previous.forEach(([a,l])=>t.setQueryData(a,l))},onSettled:()=>{t.invalidateQueries({queryKey:["documents"]})}})},V=()=>w({mutationFn:t=>x.getDownloadUrl(t),onSuccess:t=>{window.open(t.downloadUrl,"_blank","noopener,noreferrer")}});function re(){var v,U;const[t,s]=i.useState(1),[r,n]=i.useState(""),[a,l]=i.useState(null),[h,b]=i.useState(0),g=$(r,280),{pushToast:c}=L(),d=Y(t),N=Z(),E=V(),f=H(),D=i.useMemo(()=>{var m;const o=((m=d.data)==null?void 0:m.documents)||[];if(!g.trim())return o;const u=g.trim().toLowerCase();return o.filter(Q=>Q.file_name.toLowerCase().includes(u))},[g,(v=d.data)==null?void 0:v.documents]),_=async o=>{const u=W(o);if(u){c(u,"error");return}b(0);try{await N.mutateAsync({file:o,onProgress:m=>b(m)}),c("Document uploaded successfully","success")}catch(m){c(y(m).message,"error")}finally{b(0)}},M=async o=>{try{await E.mutateAsync(o)}catch(u){c(y(u).message,"error")}},F=async()=>{if(a)try{await f.mutateAsync(a),c("Document deleted","success"),l(null)}catch(o){c(y(o).message,"error")}},j=((U=d.data)==null?void 0:U.totalPages)||1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx(O,{isUploading:N.isPending,progress:h,onFileSelected:_}),e.jsxs("section",{className:"rounded-xl border border-slate-200 bg-white p-4 shadow-soft",children:[e.jsxs("div",{className:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base font-semibold text-slate-900",children:"Documents"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Secure files uploaded via signed S3 URLs."})]}),e.jsx("input",{"aria-label":"Search documents",className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm sm:w-64",placeholder:"Search by filename",value:r,onChange:o=>n(o.target.value)})]}),d.isPending?e.jsx(K,{rows:6}):null,d.isError?e.jsx(I,{message:y(d.error).message,onRetry:()=>d.refetch()}):null,!d.isPending&&!d.isError?D.length===0?e.jsx(G,{title:"No documents found",description:"Upload your first legal document to start building your secure library."}):e.jsx(J,{documents:D,onDownload:M,onDelete:o=>l(o),pendingDeleteId:f.isPending?f.variables??null:null}):null,e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["Page ",t," of ",j]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-md border border-slate-300 px-3 py-1.5 text-sm text-slate-700 disabled:opacity-50",disabled:t<=1,onClick:()=>s(o=>Math.max(1,o-1)),children:"Previous"}),e.jsx("button",{className:"rounded-md border border-slate-300 px-3 py-1.5 text-sm text-slate-700 disabled:opacity-50",disabled:t>=j,onClick:()=>s(o=>Math.min(j,o+1)),children:"Next"})]})]})]}),e.jsx(R,{isOpen:!!a,title:"Delete document",description:"This permanently removes the file from secure storage. This action cannot be undone.",confirmLabel:"Delete",danger:!0,isLoading:f.isPending,onCancel:()=>l(null),onConfirm:F})]})}export{re as default};
//# sourceMappingURL=DashboardPage-D2dylRRS.js.map
